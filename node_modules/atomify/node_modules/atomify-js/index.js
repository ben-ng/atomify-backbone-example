var browserify = require('browserify')
  , shim       = require('browserify-shim')
  , hbsfy      = require('hbsfy')
  , brfs       = require('brfs')
  , minifyify  = require('minifyify')

module.exports = function (opts, cb) {
  if (!opts.shim) opts.shim = {}

  var bundle = shim(browserify(), opts.shim)
    , minOpts = {
        file: opts.file
      , map: opts.map
      , transforms: {
          hbsfy: hbsfy
        , brfs: brfs
        }
      }

  bundle.require(require.resolve(opts.entry), {entry: true})

  minifyify(bundle, minOpts, function (code, map) {
    cb(null, code, map)
  })
}
